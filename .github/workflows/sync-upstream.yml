name: Sync upstream

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      UPSTREAM_URL: https://github.com/NixOS/nixpkgs.git
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch
        id: branch
        run: |
          branch="${DEFAULT_BRANCH:-${GITHUB_REF_NAME:-${GITHUB_REF#refs/heads/}}}"
          [ -n "$branch" ] || branch="master"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"

      - name: Ensure upstream remote
        run: |
          git remote get-url upstream && \
            git remote set-url upstream "$UPSTREAM_URL" || \
            git remote add upstream "$UPSTREAM_URL"

      - name: Check upstream delta
        id: diff
        run: |
          branch="${{ steps.branch.outputs.branch }}"
          up_sha=$(git ls-remote upstream "$branch" | awk '{print $1}')
          origin_sha=$(git ls-remote origin "$branch" | awk '{print $1}')
          echo "upstream=$up_sha"
          echo "origin=$origin_sha"
          if [ "$up_sha" = "$origin_sha" ] || [ -z "$up_sha" ]; then
            echo "noop=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if no changes
        if: steps.diff.outputs.noop == 'true'
        run: echo "Upstream unchanged; skipping sync."

      - name: Fetch upstream
        if: steps.diff.outputs.noop != 'true'
        run: git fetch upstream

      - name: Configure git identity
        if: steps.diff.outputs.noop != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fast-forward default branch
        if: steps.diff.outputs.noop != 'true'
        run: |
          branch="${{ steps.branch.outputs.branch }}"
          git checkout "$branch"
          # 优先快进；若有本地额外提交则回退到常规合并，避免工作流失败
          git merge "upstream/$branch" --ff-only || git merge "upstream/$branch" --no-edit

      - name: Push to origin
        if: steps.diff.outputs.noop != 'true'
        run: |
          branch="${{ steps.branch.outputs.branch }}"
          git push origin "$branch"
