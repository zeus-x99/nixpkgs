name: Sync upstream

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 6 * * *'
    - cron: '0 12 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      UPSTREAM_URL: https://github.com/NixOS/nixpkgs.git
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure upstream remote
        run: |
          git remote get-url upstream && \
            git remote set-url upstream "$UPSTREAM_URL" || \
            git remote add upstream "$UPSTREAM_URL"

      - name: Fetch upstream
        run: git fetch upstream

      - name: Fast-forward default branch
        run: |
          # github.event.repository.default_branch 在 schedule 事件中为空，
          # fallback 使用 GITHUB_REF_NAME / GITHUB_REF 获取默认分支名称。
          branch="${DEFAULT_BRANCH:-${GITHUB_REF_NAME:-${GITHUB_REF#refs/heads/}}}"
          [ -n "$branch" ] || branch="master"
          git checkout "$branch"
          git merge "upstream/$branch" --ff-only

      - name: Push to origin
        run: |
          branch="${DEFAULT_BRANCH:-master}"
          git push origin "$branch"
